using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MediatR;
using BankMore.ContaCorrente.Application.Commands;
using BankMore.ContaCorrente.Application.DTOs;
using BankMore.ContaCorrente.Application.Queries;
using System.Security.Claims;

namespace BankMore.ContaCorrente.Api.Controllers;

/// <summary>
/// Controller para gerenciamento de Contas Correntes
/// </summary>
[ApiController]
[Route("api/[controller]")]
[Produces("application/json")]
public class ContaController : ControllerBase
{
    private readonly IMediator _mediator;

    public ContaController(IMediator mediator)
    {
        _mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
    }

    /// <summary>
    /// Cadastra uma nova conta corrente
    /// </summary>
    /// <param name="request">Dados para cadastro da conta</param>
    /// <returns>Número da conta criada</returns>
    /// <response code="200">Conta cadastrada com sucesso</response>
    /// <response code="400">CPF inválido ou dados inconsistentes</response>
    [HttpPost]
    [AllowAnonymous]
    [ProducesResponseType(typeof(ContaCadastradaDto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ErroDto), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ContaCadastradaDto>> CadastrarConta([FromBody] CadastrarContaCommand request)
    {
        try
        {
            var resultado = await _mediator.Send(request);
            return Ok(resultado);
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INVALID_DOCUMENT"))
        {
            return BadRequest(new ErroDto
            {
                Tipo = "INVALID_DOCUMENT",
                Mensagem = "CPF inválido"
            });
        }
        catch (Exception ex)
        {
            return BadRequest(new ErroDto
            {
                Tipo = "ERROR",
                Mensagem = ex.Message
            });
        }
    }

    /// <summary>
    /// Inativa uma conta corrente
    /// </summary>
    /// <param name="request">Senha da conta para confirmação</param>
    /// <returns>Status da operação</returns>
    /// <response code="204">Conta inativada com sucesso</response>
    /// <response code="400">Dados inconsistentes</response>
    /// <response code="401">Senha incorreta</response>
    /// <response code="403">Token inválido ou expirado</response>
    [HttpPut("inativar")]
    [Authorize]
    [ProducesResponseType(StatusCodes.Status204NoContent)]
    [ProducesResponseType(typeof(ErroDto), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(ErroDto), StatusCodes.Status401Unauthorized)]
    [ProducesResponseType(StatusCodes.Status403Forbidden)]
    public async Task<IActionResult> InativarConta([FromBody] InativarContaRequest request)
    {
        try
        {
            var idContaCorrente = User.FindFirstValue("idcontacorrente");
            
            if (string.IsNullOrEmpty(idContaCorrente))
                return Forbid();

            var command = new InativarContaCommand
            {
                IdContaCorrente = idContaCorrente,
                Senha = request.Senha
            };

            await _mediator.Send(command);
            return NoContent();
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INVALID_ACCOUNT"))
        {
            return BadRequest(new ErroDto
            {
                Tipo = "INVALID_ACCOUNT",
                Mensagem = "Conta não cadastrada"
            });
        }
        catch (UnauthorizedAccessException)
        {
            return Unauthorized(new ErroDto
            {
                Tipo = "USER_UNAUTHORIZED",
                Mensagem = "Senha incorreta"
            });
        }
    }

    /// <summary>
    /// Consulta o saldo da conta corrente
    /// </summary>
    /// <returns>Dados do saldo</returns>
    /// <response code="200">Consulta realizada com sucesso</response>
    /// <response code="400">Conta inválida ou inativa</response>
    /// <response code="403">Token inválido ou expirado</response>
    [HttpGet("saldo")]
    [Authorize]
    [ProducesResponseType(typeof(SaldoDto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ErroDto), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status403Forbidden)]
    public async Task<ActionResult<SaldoDto>> ConsultarSaldo()
    {
        try
        {
            var idContaCorrente = User.FindFirstValue("idcontacorrente");
            
            if (string.IsNullOrEmpty(idContaCorrente))
                return Forbid();

            var query = new ConsultarSaldoQuery
            {
                IdContaCorrente = idContaCorrente
            };

            var resultado = await _mediator.Send(query);
            return Ok(resultado);
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INVALID_ACCOUNT"))
        {
            return BadRequest(new ErroDto
            {
                Tipo = "INVALID_ACCOUNT",
                Mensagem = "Conta não cadastrada"
            });
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INACTIVE_ACCOUNT"))
        {
            return BadRequest(new ErroDto
            {
                Tipo = "INACTIVE_ACCOUNT",
                Mensagem = "Conta inativa"
            });
        }
    }
}

/// <summary>
/// Request para inativar conta
/// </summary>
public class InativarContaRequest
{
    /// <summary>
    /// Senha da conta para confirmação
    /// </summary>
    public string Senha { get; set; } = string.Empty;
}
