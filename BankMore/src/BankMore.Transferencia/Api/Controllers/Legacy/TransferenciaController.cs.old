using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MediatR;
using System.Security.Claims;
using BankMore.Transferencia.Application.Commands;
using BankMore.Transferencia.Application.DTOs;

namespace BankMore.Transferencia.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]
[Produces("application/json")]
public class TransferenciaController : ControllerBase
{
    private readonly IMediator _mediator;

    public TransferenciaController(IMediator mediator)
    {
        _mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
    }

    /// <summary>
    /// Realiza transferência entre contas
    /// </summary>
    /// <param name="request">Dados da transferência (chave idempotência, conta destino, valor)</param>
    /// <returns>Sucesso ou erro</returns>
    /// <response code="200">Transferência realizada com sucesso</response>
    /// <response code="400">Dados inválidos (INVALID_VALUE, INVALID_ACCOUNT)</response>
    /// <response code="403">Token JWT inválido/expirado</response>
    /// <response code="422">Conta inativa ou saldo insuficiente (INACTIVE_ACCOUNT, INSUFFICIENT_BALANCE)</response>
    [HttpPost]
    [ProducesResponseType(typeof(TransferenciaResponseDto), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status403Forbidden)]
    [ProducesResponseType(StatusCodes.Status422UnprocessableEntity)]
    public async Task<IActionResult> RealizarTransferencia([FromBody] TransferenciaRequestDto request)
    {
        try
        {
            // Extrair ID da conta do token JWT
            var idContaClaim = User.FindFirst(ClaimTypes.NameIdentifier);
            if (idContaClaim == null)
            {
                return Forbid();
            }

            // Obter token JWT do header
            var token = Request.Headers["Authorization"].ToString().Replace("Bearer ", "");

            var command = new RealizarTransferenciaCommand
            {
                ChaveIdempotencia = request.ChaveIdempotencia,
                IdContaCorrenteOrigem = idContaClaim.Value,
                NumeroContaDestino = request.NumeroContaDestino,
                Valor = request.Valor,
                Token = token
            };

            var resultado = await _mediator.Send(command);

            return Ok(new
            {
                Sucesso = true,
                Mensagem = "Transferência realizada com sucesso",
                IdTransferencia = resultado.Id,
                Valor = resultado.Valor,
                Data = resultado.DataTransferencia
            });
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INVALID_VALUE"))
        {
            return BadRequest(new { Erro = "INVALID_VALUE", Mensagem = "Valor inválido" });
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INVALID_ACCOUNT"))
        {
            return BadRequest(new { Erro = "INVALID_ACCOUNT", Mensagem = "Conta inválida" });
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INACTIVE_ACCOUNT"))
        {
            return UnprocessableEntity(new { Erro = "INACTIVE_ACCOUNT", Mensagem = "Conta inativa" });
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("INSUFFICIENT_BALANCE"))
        {
            return UnprocessableEntity(new { Erro = "INSUFFICIENT_BALANCE", Mensagem = "Saldo insuficiente" });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { Erro = "INTERNAL_ERROR", Mensagem = ex.Message });
        }
    }
}
